<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Corporativo de Vendas</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- AOS CSS (Animate On Scroll) -->
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <!-- Notyf CSS (para notificações toast) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
    <!-- SweetAlert2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <!-- Google Fonts: Roboto e Merriweather -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Merriweather:700&display=swap"
      rel="stylesheet"
    />
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
    />

    <!-- jsPDF e autoTable para geração de PDF -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"
      defer
    ></script>
    <!-- Day.js para datas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" defer></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <!-- Notyf JS -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js" defer></script>

    <style>
      :root {
        --primary: #1a4789;
        --primary-dark: #0d2b54;
        --secondary: #3c6eb4;
        --accent: #ff6b00;
        --success: #2d8a47;
        --danger: #dc3545;
        --warning: #ffc107;
        --background: #f4f6f9;
        --surface: #ffffff;
        --text: #2c3e50;
        --border: #dee2e6;
        --header-bg: #1a4789;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .dark-mode {
        --primary: #3c6eb4;
        --primary-dark: #1a4789;
        --secondary: #5d8ac9;
        --accent: #ff8533;
        --background: #1a202c;
        --surface: #2d3748;
        --text: #e2e8f0;
        --border: #4a5568;
        --header-bg: #2d3748;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', sans-serif;
        background-color: var(--background);
        color: var(--text);
        line-height: 1.6;
        transition: background-color 0.3s, color 0.3s;
        overflow-y: auto;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      body::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
      }

      /* Header Corporativo */
      #topHeader {
        background: var(--header-bg);
        background-image: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1920px;
        margin: 0 auto;
      }

      .company-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .company-logo {
        font-size: 1.5rem;
        color: var(--accent);
      }

      /* Container Principal com Tema Rodoviário */
      main.container {
        max-width: 1920px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .content-card {
        background: var(--surface);
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        border-top: 4px solid var(--accent);
      }

      /* Título com Ícone */
      .page-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        color: var(--primary);
        font-size: 1.75rem;
      }

      .page-title i {
        color: var(--accent);
      }

      /* Form Header Estilizado */
      .form-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1.5rem;
        align-items: center;
      }

      /* Botões Corporativos */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: #e65c00;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: var(--secondary);
        color: white;
      }

      /* Select Estilizado */
      .form-select {
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--surface);
        color: var(--text);
        min-width: 200px;
      }

      /* Tabela Corporativa */
      .table-container {
        margin-top: 2rem;
        border-radius: 8px;
        overflow-x: auto;
        overflow-y: hidden;
        border: 1px solid var(--border);
        padding-bottom: 16px;
      }

      table {
        width: max-content;
        border-collapse: separate;
        border-spacing: 0;
        min-width: unset;
        table-layout: fixed;
      }

      th {
        background: var(--primary);
        color: white;
        font-weight: 500;
        text-align: left;
        padding: 1rem;
        font-size: 0.95rem;
        position: relative;
        user-select: none;
      }

      td {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
        min-width: 100px;
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      tr:hover td {
        background: rgba(60, 110, 180, 0.05);
      }

      /* Inputs Corporativos */
      .form-input, input[type="text"], input[type="date"], textarea, select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--surface);
        color: var(--text);
        font-size: 0.95rem;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .form-input:focus, 
      input[type="text"]:focus, 
      input[type="date"]:focus, 
      textarea:focus, 
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 71, 137, 0.1);
        transform: translateY(-1px);
      }

      /* Estilo específico para textareas */
      textarea {
        min-height: unset;
        height: 38px;
        resize: none;
        line-height: 1.5;
        padding: 8px 12px;
      }

      /* Estilo para checkbox */
      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid var(--primary);
        cursor: pointer;
      }

      /* Botões de Ação */
      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }

      /* Ícones na Tabela */
      .table-icon {
        color: var(--primary);
        margin-right: 0.5rem;
      }

      /* Estilização da barra de rolagem */
      .table-container::-webkit-scrollbar {
        height: 16px;
      }

      .table-container::-webkit-scrollbar-track {
        background: var(--background);
        border-radius: 8px;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: var(--secondary);
        border-radius: 8px;
        border: 3px solid var(--background);
        min-width: 50px;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
        cursor: pointer;
      }

      /* Container para os botões de ação */
      .row-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
      }

      /* Atualização dos botões de ação */
      .action-btn {
        width: 38px;
        height: 38px;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn-duplicate {
        background-color: var(--primary);
      }

      .btn-duplicate:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
      }

      .btn-delete {
        background-color: var(--danger);
      }

      .btn-delete:hover {
        background-color: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
      }

      /* Estilo para placeholder */
      ::placeholder {
        color: #94a3b8;
        opacity: 0.7;
      }

      .resize-handle {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 8px;
        cursor: col-resize;
        background-color: rgba(255, 255, 255, 0.2);
        transition: background-color 0.2s;
      }

      .resize-handle:hover {
        background-color: var(--accent);
      }

      /* Indicador visual durante o redimensionamento */
      th.resizing {
        background-color: var(--primary-dark);
      }

      th.resizing .resize-handle {
        background-color: var(--accent);
      }

      /* Ajuste dos inputs para se adequarem melhor às células */
      td input[type="text"],
      td input[type="date"],
      td textarea,
      td select {
        width: calc(100% - 4px);
        margin: 0;
        padding: 6px 8px;
      }

      /* Ajuste das larguras iniciais das colunas */
      th:nth-child(1), td:nth-child(1) { /* Fornecedor */
        width: 188px;
      }
      th:nth-child(2), td:nth-child(2) { /* Viação */
        width: 188px;
      }
      th:nth-child(3), td:nth-child(3) { /* Centro de Custos */
        width: 185px;
      }
      th:nth-child(4), td:nth-child(4) { /* Localizador */
        width: 178px;
      }
      th:nth-child(5), td:nth-child(5) { /* Origem */
        width: 259px;
      }
      th:nth-child(6), td:nth-child(6) { /* Destino */
        width: 273px;
      }
      th:nth-child(7), td:nth-child(7) { /* Ida e Volta */
        width: 110px;
      }
      th:nth-child(8), td:nth-child(8) { /* Solicitante */
        width: 209px;
      }
      th:nth-child(9), td:nth-child(9) { /* Data Oficio */
        width: 196px;
      }
      th:nth-child(10), td:nth-child(10) { /* Emissor */
        width: 193px;
      }
      th:nth-child(11), td:nth-child(11) { /* Nº Oficio */
        width: 85px;
      }
      th:nth-child(12), td:nth-child(12) { /* Passageiro */
        width: 169px;
      }
      th:nth-child(13), td:nth-child(13) { /* Data de ida */
        width: 172px;
      }
      th:nth-child(14), td:nth-child(14) { /* Data de volta */
        width: 172px;
      }
      th:nth-child(15), td:nth-child(15) { /* Valor Tarifa */
        width: 140px;
      }
      th:nth-child(16), td:nth-child(16) { /* MU */
        width: 140px;
      }
      th:nth-child(17), td:nth-child(17) { /* Ações */
        width: 100px;
      }

      .input-error {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 1px var(--danger) !important;
      }

      /* Adicionar estilo para destacar o select quando não selecionado */
      #clienteSelecionado.not-selected {
        border-color: var(--danger);
        box-shadow: 0 0 0 1px var(--danger);
      }
    </style>
  </head>
  <body>
    <header id="topHeader">
      <div class="header-content">
        <div class="company-info">
          <i class="fas fa-bus company-logo"></i>
          <div>
            <div class="font-weight-bold">PLUS VIAGENS E TURISMO LTDA</div>
            <div id="dateTimeDisplay" class="text-sm"></div>
          </div>
        </div>
        <button class="btn-icon" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </header>

    <main class="container">
      <div class="content-card">
        <h1 class="page-title">
          <i class="fas fa-route"></i>
          Sistema de Integração de TFD
        </h1>

        <div class="form-header">
          <button class="btn btn-primary" onclick="addRow()">
            <i class="fas fa-plus"></i>
            Nova Viagem
          </button>
          
          <select id="clienteSelecionado" class="form-select">
            <option value="" disabled selected>Selecione o TFD que irá gerar a venda:</option>
            <option value="01804">TFD LEM</option>
            <option value="02026">TFD VDC</option>
          </select>
          
          <div id="progressIndicator" class="text-white">
            <i class="fas fa-list-check"></i>
            Linhas: 0
          </div>
        </div>

        <div class="table-container">
          <table id="vendasTable" role="table">
            <thead>
              <tr role="row">
                <th>Fornecedor de Emissão</th>
                <th>Viação Emitida</th>
                <th>Centro de Custos</th>
                <th>Localizador</th>
                <th>Origem</th>
                <th>Destino</th>
                <th>Ida e Volta</th>
                <th>Solicitante</th>
                <th>Data Oficio</th>
                <th>Emissor</th>
                <th>Nº Oficio</th>
                <th>Passageiro</th>
                <th>Data de ida</th>
                <th>Data de volta</th>
                <th>Valor Tarifa</th>
                <th>MU</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- As linhas serão adicionadas dinamicamente -->
            </tbody>
          </table>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="confirmReset()">
            <i class="fas fa-undo"></i>
            Resetar Formulário
          </button>
          <button class="btn btn-primary" onclick="gerarXML()">
            <i class="fas fa-file-export"></i>
            Gerar XML
          </button>
        </div>
      </div>
    </main>

    <!-- Bootstrap 5 JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>

    <!-- Nosso código inline -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Instância do Notyf
        window.notyf = new Notyf();

        // Atualiza o relógio
        window.updateClock = function () {
          const now = dayjs();
          document.getElementById("dateTimeDisplay").textContent =
            now.format("DD/MM/YYYY HH:mm:ss");
        };
        setInterval(updateClock, 1000);
        updateClock();

        // Alterna modo claro/escuro
        window.toggleDarkMode = function () {
          document.body.classList.toggle("dark-mode");
        };

        // Atualiza contador de linhas
        window.updateProgress = function () {
          const rowCount = document.querySelectorAll("#vendasTable tbody tr").length;
          document.getElementById("progressIndicator").textContent = `Linhas: ${rowCount}`;
        };

        // Atualizar a definição dos campos obrigatórios removendo o Nº Ofício
        const camposObrigatorios = [
          { index: 2, nome: "Centro de Custos" },
          { index: 3, nome: "Localizador" },
          { index: 4, nome: "Origem" },
          { index: 5, nome: "Destino" },
          { index: 7, nome: "Solicitante" },
          { index: 8, nome: "Data Ofício" },
          { index: 9, nome: "Emissor" },
          { index: 11, nome: "Passageiro" },
          { index: 12, nome: "Data de ida" },
          { index: 14, nome: "Valor Tarifa" }
        ];

        // ********************
        // DEFINIÇÃO DA FUNÇÃO getCellValue
        // ********************
        window.getCellValue = function (cell) {
          const selectElem = cell.querySelector("select");
          if (selectElem) {
            if (selectElem.value === "Outros") {
              const customInput = cell.querySelector("input[name='emissor_custom']");
              return customInput ? customInput.value.trim() : "";
            }
            return selectElem.value;
          }
          const input = cell.querySelector("input, textarea");
          if (input) {
            return input.value.trim();
          }
          return cell.textContent.trim();
        };

        /* Validação: apenas o campo Valor Tarifa é obrigatório.
           Fornecedor e Data de volta não são obrigatórios. */
        window.validateRows = function () {
          let valid = true;
          const rows = document.querySelectorAll("#vendasTable tbody tr");
          
          rows.forEach((row, rowIndex) => {
            const inputs = row.querySelectorAll("input, textarea, select");
            
            // Remove todas as marcações de erro anteriores
            inputs.forEach(input => input.classList.remove("input-error"));
            
            let camposFaltantes = [];
            
            camposObrigatorios.forEach(campo => {
              const input = inputs[campo.index];
              const valor = input ? input.value.trim() : '';
              
              // Debug mais detalhado
              console.log(`Linha ${rowIndex + 1} - Campo ${campo.nome}:`, {
                index: campo.index,
                elemento: input,
                valor: valor
              });
              
              if (!valor) {
                if (input) input.classList.add("input-error");
                camposFaltantes.push(campo.nome);
                valid = false;
              }
            });

            if (camposFaltantes.length > 0) {
              Swal.fire({
                title: "Campos Obrigatórios",
                html: `Por favor, preencha os seguintes campos:<br><br>${camposFaltantes.join("<br>")}`,
                icon: "warning"
              });
            }
          });
          
          return valid;
        };

        // Adiciona uma nova linha com os campos e botões
        window.addRow = function () {
          const tbody = document.querySelector("#vendasTable tbody");
          const newRow = document.createElement("tr");
          const campos = [
            "codigo_fornecedor",
            "cia_iata",
            "ccustos_cliente",
            "localizador",
            "origem",
            "destino",
            "ida_e_volta",
            "solicitante",
            "data_lancamento",
            "emissor",
            "numero_requisicao",
            "passageiro",
            "data_inicio_outros_svcs",
            "data_fim_outros_svcs",
            "valor_tarifa",
            "markup",
          ];
          campos.forEach((campo) => {
            const td = document.createElement("td");
            let element;
            if (campo === "ida_e_volta") {
              element = document.createElement("input");
              element.type = "checkbox";
              element.checked = false;
            } else if (
              campo === "data_inicio_outros_svcs" ||
              campo === "data_fim_outros_svcs" ||
              campo === "data_lancamento"
            ) {
              element = document.createElement("input");
              element.type = "date";
            } else if (campo === "solicitante") {
              element = document.createElement("textarea");
              element.rows = 1;
            } else if (campo === "emissor") {
              // Cria container para select e input customizado
              const container = document.createElement("div");
              container.style.display = "flex";
              container.style.flexDirection = "column";

              const selectElem = document.createElement("select");
              selectElem.name = campo;
              selectElem.setAttribute("aria-label", "Emissor");
              const idEmissor = campo + "_" + Date.now();
              selectElem.id = idEmissor;

              const emissorOptions = [
                "Fabiane",
                "Eduardo",
                "Fabio Vardi",
                "Thomix",
                "Edilson",
                "Giovane",
                "Henrique",
                "Outros",
              ];
              emissorOptions.forEach((opt) => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                selectElem.appendChild(option);
              });

              const customInput = document.createElement("input");
              customInput.type = "text";
              customInput.name = "emissor_custom";
              customInput.placeholder = "Escreva o emissor";
              customInput.style.display = "none";

              // Exibe input se "Outros" for selecionado
              selectElem.addEventListener("change", function () {
                if (selectElem.value === "Outros") {
                  customInput.style.display = "block";
                  customInput.focus();
                } else {
                  customInput.style.display = "none";
                }
              });

              container.appendChild(selectElem);
              container.appendChild(customInput);
              element = container;
            } else {
              element = document.createElement("input");
              element.type = "text";
              if (campo === "valor_tarifa" || campo === "markup") {
                element.pattern = "[0-9.]*";
                element.inputMode = "decimal";
              }
              if (campo === "passageiro") {
                element.maxLength = 60;
                element.addEventListener("input", function () {
                  if (
                    element.value.length === 60 &&
                    !element.dataset.warningShown
                  ) {
                    notyf.warning("Limite de 60 caracteres atingido!");
                    element.dataset.warningShown = "true";
                  } else if (element.value.length < 60) {
                    element.dataset.warningShown = "";
                  }
                });
              }
            }
            element.name = campo;
            const label = document.createElement("label");
            if (campo === "markup") {
              label.textContent = "MU";
              element.placeholder = "MU";
              element.setAttribute("aria-label", "MU");
            } else if (campo === "emissor") {
              label.textContent = "Emissor";
              label.htmlFor = campo + "_" + Date.now();
            } else {
              label.textContent = campo.replace(/_/g, " ");
              element.placeholder = campo.replace(/_/g, " ");
              element.setAttribute("aria-label", campo.replace(/_/g, " "));
            }
            if (campo !== "emissor") {
              label.htmlFor = campo + "_" + Date.now();
              element.id = label.htmlFor;
            }
            label.classList.add("sr-only");
            td.appendChild(label);
            td.appendChild(element);
            newRow.appendChild(td);
          });

          // Atualização dos botões de ação
          const tdAcoes = document.createElement("td");
          tdAcoes.className = "row-actions";

          const btnClone = document.createElement("button");
          btnClone.innerHTML = '<i class="fas fa-file-circle-plus"></i>';
          btnClone.className = "action-btn btn-duplicate";
          btnClone.setAttribute("aria-label", "Duplicar registro");
          btnClone.title = "Duplicar registro";
          btnClone.onclick = function () {
            cloneRow(newRow);
          };

          const btnRemover = document.createElement("button");
          btnRemover.innerHTML = '<i class="fas fa-file-circle-xmark"></i>';
          btnRemover.className = "action-btn btn-delete";
          btnRemover.setAttribute("aria-label", "Excluir registro");
          btnRemover.title = "Excluir registro";
          btnRemover.onclick = function () {
            newRow.remove();
            updateProgress();
            notyf.success("Linha removida!");
          };

          tdAcoes.appendChild(btnClone);
          tdAcoes.appendChild(btnRemover);
          newRow.appendChild(tdAcoes);
          tbody.appendChild(newRow);
          updateProgress();
          notyf.success("Linha adicionada!");
        };

        // Função para clonar uma linha
        window.cloneRow = function (row) {
          const clone = row.cloneNode(true);
          
          // Corrigir os botões de ação no clone
          const actionCell = clone.lastElementChild;
          const btnClone = actionCell.querySelector(".btn-duplicate");
          const btnRemover = actionCell.querySelector(".btn-delete");
          
          btnClone.onclick = function () {
            cloneRow(clone);
          };
          
          btnRemover.onclick = function () {
            clone.remove();
            updateProgress();
            notyf.success("Linha removida!");
          };

          // Copiar valores dos campos
          const originalInputs = row.querySelectorAll('input, textarea, select');
          const cloneInputs = clone.querySelectorAll('input, textarea, select');
          
          originalInputs.forEach((input, index) => {
            if (input.type === 'checkbox') {
              cloneInputs[index].checked = input.checked;
            } else if (input.type === 'select-one') {
              cloneInputs[index].value = input.value;
              // Se for o select de emissor e estiver como "Outros"
              if (input.value === 'Outros') {
                const originalCustomInput = input.parentElement.querySelector('input[name="emissor_custom"]');
                const cloneCustomInput = cloneInputs[index].parentElement.querySelector('input[name="emissor_custom"]');
                if (originalCustomInput && cloneCustomInput) {
                  cloneCustomInput.value = originalCustomInput.value;
                  cloneCustomInput.style.display = 'block';
                }
              }
            } else {
              cloneInputs[index].value = input.value;
            }
          });

          // Inserir o clone após a linha original
          row.parentNode.insertBefore(clone, row.nextSibling);
          updateProgress();
          notyf.success("Linha clonada com sucesso!");
        };

        // Retorna data/hora formatada para nome de arquivos
        window.getFormattedDateTime = function () {
          return dayjs().format("YYYYMMDD_HHmmss");
        };

        // Gera o comprovante em PDF usando jsPDF e autoTable
        window.gerarPDF = function (pdfFileName) {
          const rows = document.querySelectorAll("#vendasTable tbody tr");
          let pdfData = [];
          rows.forEach((row, index) => {
            const cells = row.querySelectorAll("td");
            const localizador = getCellValue(cells[3]);
            const origem = getCellValue(cells[4]);
            const destino = getCellValue(cells[5]);
            const emissor = getCellValue(cells[9]);
            const numeroOficio = getCellValue(cells[10]);
            const dataOficio = getCellValue(cells[8]);
            const passageiro = getCellValue(cells[11]);
            pdfData.push([
              index + 1,
              localizador,
              passageiro,
              origem,
              destino,
              numeroOficio,
              dataOficio,
              emissor,
            ]);
          });
          const headers = [
            [
              "N° Linha",
              "Localizador",
              "Passageiro",
              "Origem",
              "Destino",
              "Nº Oficio",
              "Data Oficio",
              "Emissor",
            ],
          ];

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.autoTable({
            head: headers,
            body: pdfData,
            startY: 20,
            theme: "grid",
            headStyles: { fillColor: [30, 42, 56] },
            styles: { fontSize: 10 },
          });
          doc.save(pdfFileName);
        };

        // Gera o XML e o PDF aplicando as condições:
        // - Se o cliente for TFD LEM e o Fornecedor estiver em branco, usa "F03063"
        // - Se for somente ida (checkbox não marcado) e Data de volta estiver em branco,
        //   preenche Data de volta com a Data de ida.
        window.gerarXML = function () {
          const clienteSelecionado = document.getElementById("clienteSelecionado").value;
          
          // Verificar se um TFD foi selecionado
          if (!clienteSelecionado) {
            Swal.fire({
              title: "Atenção",
              text: "Você esqueceu de selecionar o TFD no qual está emitindo.",
              icon: "warning"
            });
            return;
          }

          const rows = document.querySelectorAll("#vendasTable tbody tr");
          
          if (rows.length === 0) {
            Swal.fire(
              "Atenção",
              "Nenhuma linha adicionada. Adicione pelo menos uma linha antes de gerar os arquivos.",
              "warning"
            );
            return;
          }
          
          if (!validateRows()) {
            return;
          }
          
          const vendas = [];
          rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const inputs = row.querySelectorAll("input, textarea");
            
            // Lógica para definir o fornecedor baseado no cliente selecionado
            const fornecedorValue = inputs[0].value.trim();
            let codigoFornecedor;
            
            if (!fornecedorValue) {
              if (clienteSelecionado === "01804") {
                codigoFornecedor = "F03063";  // TFD LEM
              } else if (clienteSelecionado === "02026") {
                codigoFornecedor = "MAXTOUR"; // TFD VDC
              }
            } else {
              codigoFornecedor = fornecedorValue;
            }

            // Lógica para definir a viação baseado no cliente selecionado
            const viacaoValue = inputs[1].value.trim();
            let cia_iata;
            
            if (!viacaoValue) {
              if (clienteSelecionado === "02026") {
                cia_iata = "ROTA"; // TFD VDC
              } else {
                cia_iata = "RAPIDO FEDERAL"; // Valor padrão
              }
            } else {
              cia_iata = viacaoValue;
            }

            const dados = {
              codigo_fornecedor: codigoFornecedor,
              cia_iata: cia_iata,
              ccustos_cliente: inputs[2].value || "NAO INFORMADO",
              localizador: inputs[3].value || "",
              origem: inputs[4].value || "",
              destino: inputs[5].value || "",
              ida_e_volta: inputs[6].checked,
              solicitante: limparTexto(inputs[7].value),
              data_lancamento: inputs[8].value,
              emissor: getCellValue(cells[9]),
              numero_requisicao: inputs[10].value,
              passageiro: limparTexto(inputs[11].value),
              data_inicio_outros_svcs: inputs[12].value,
              data_fim_outros_svcs: inputs[13].value,
              valor_tarifa: inputs[14].value,
              markup: inputs[15].value,
            };

            // Se for somente ida e Data de volta estiver em branco,
            // preenche com a mesma data da ida.
            if (!dados.ida_e_volta && !dados.data_fim_outros_svcs.trim()) {
              dados.data_fim_outros_svcs = dados.data_inicio_outros_svcs;
            }

            if (dados.data_inicio_outros_svcs) {
              dados.data_inicio_outros_svcs = dayjs(dados.data_inicio_outros_svcs).format("DD/MM/YYYY");
            }
            if (dados.data_fim_outros_svcs) {
              dados.data_fim_outros_svcs = dayjs(dados.data_fim_outros_svcs).format("DD/MM/YYYY");
            }
            let origemVal = limparTexto(dados.origem);
            let destinoVal = limparTexto(dados.destino);
            let descricao_outros_svcs = "";
            if (origemVal || destinoVal) {
              descricao_outros_svcs = dados.ida_e_volta
                ? `${origemVal} / ${destinoVal} / ${origemVal}`
                : `${origemVal} / ${destinoVal}`;
            }
            const bilhete = `
          <bilhete>
            <idv_externo>${Math.floor(Math.random() * 100000000).toString().padStart(8, "0")}</idv_externo>
            <data_lancamento>${dados.data_lancamento}</data_lancamento>
            <codigo_produto>RDV</codigo_produto>
            <codigo_fornecedor>${dados.codigo_fornecedor}</codigo_fornecedor>
            <cia_iata>${dados.cia_iata}</cia_iata>
            <forma_de_pagamento>IV</forma_de_pagamento>
            <moeda>BRL</moeda>
            <emissor>${dados.emissor}</emissor>
            <cliente>${clienteSelecionado}</cliente>
            <ccustos_cliente>${dados.ccustos_cliente}</ccustos_cliente>
            <data_requisicao>${dados.data_lancamento}</data_requisicao>
            <numero_requisicao>${dados.numero_requisicao}</numero_requisicao>
            <passageiro>${dados.passageiro}</passageiro>
            <tipo_passageiro>A</tipo_passageiro>
            <solicitante>${dados.solicitante}</solicitante>
            <tipo_domest_inter>D</tipo_domest_inter>
            <localizador>${dados.localizador}</localizador>
            <tipo_roteiro>7</tipo_roteiro>
            <roteiro>
              <outros_servicos>
                <data_inicio_outros_svcs>${dados.data_inicio_outros_svcs}</data_inicio_outros_svcs>
                <data_fim_outros_svcs>${dados.data_fim_outros_svcs}</data_fim_outros_svcs>
                <descricao_outros_svcs><![CDATA[${descricao_outros_svcs}]]></descricao_outros_svcs>
              </outros_servicos>
            </roteiro>
            <valores>
              <item>
                <codigo>tarifa</codigo>
                <valor>${dados.valor_tarifa}</valor>
              </item>
              <item>
                <codigo>taxa</codigo>
                <valor>0.00</valor>
              </item>
              <item>
                <codigo>markup</codigo>
                <valor>${dados.markup}</valor>
              </item>
              <item>
                <codigo>fee</codigo>
                <valor>0.00</valor>
              </item>
            </valores>
          </bilhete>
        `;
            vendas.push(bilhete);
          });
          const xmlHeader = `
        <bilhetes>
          <nr_arquivo>39856210520240925</nr_arquivo>
          <data_geracao>${new Date().toLocaleDateString("pt-BR")}</data_geracao>
          <hora_geracao>${new Date().toLocaleTimeString("pt-BR", {
            hour: "2-digit",
            minute: "2-digit",
          })}</hora_geracao>
          <nome_agencia>Plus Viagens</nome_agencia>
          <versao_xml>4</versao_xml>
      `;
          const xmlFooter = `</bilhetes>`;
          const xmlContent = xmlHeader + vendas.join("") + xmlFooter;

          const dateTimeStr = getFormattedDateTime();
          let baseFileName = "";
          if (clienteSelecionado === "02026") {
            baseFileName = `VDC_${dateTimeStr}`;
          } else if (clienteSelecionado === "01804") {
            baseFileName = `LEM_${dateTimeStr}`;
          } else {
            baseFileName = `vendas_${dateTimeStr}`;
          }
          const xmlFileName = baseFileName + ".xml";
          const pdfFileName = baseFileName + "_comprovante.pdf";

          // Download do XML
          const blob = new Blob([xmlContent], { type: "application/xml" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = xmlFileName;
          link.click();

          // Gera e baixa o PDF
          gerarPDF(pdfFileName);

          notyf.success("Arquivos gerados com sucesso!");
          Swal.fire({
            title: "Sucesso!",
            text: "XML e comprovante em PDF gerados! Envie por e-mail para tic@plus.tur.br para a integração no financeiro.",
            icon: "success",
            confirmButtonText: "Fechar",
          });
        };

        // Função para limpar texto (removendo acentos e caracteres especiais)
        window.limparTexto = function (texto) {
          return texto
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-zA-Z0-9\s\-/]/g, "");
        };

        // Função global para resetar o formulário
        window.confirmReset = function () {
          Swal.fire({
            title: "Confirmação",
            text: "Tem certeza que deseja resetar o formulário? Essa ação não pode ser desfeita.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sim",
            cancelButtonText: "Não",
          }).then((result) => {
            if (result.isConfirmed) {
              document.querySelector("#vendasTable tbody").innerHTML = "";
              updateProgress();
              Swal.fire("Formulário resetado!", "", "success");
            }
          });
        };

        // Inicializa o AOS
        AOS.init();

        // Listener para restringir inputs de Valor Tarifa e MU
        document.addEventListener("input", function (e) {
          if (
            e.target &&
            (e.target.name === "valor_tarifa" || e.target.name === "markup")
          ) {
            e.target.value = e.target.value.replace(/[^0-9.]/g, "");
            const partes = e.target.value.split(".");
            if (partes.length > 2) {
              e.target.value = partes.shift() + "." + partes.join("");
            }
          }
        });

        // Listener para recalcular MU a partir da Tarifa
        document.addEventListener("input", function (e) {
          if (e.target && e.target.name === "valor_tarifa") {
            let row = e.target.closest("tr");
            if (row) {
              let tarifa = parseFloat(e.target.value);
              if (!isNaN(tarifa)) {
                let markupField = row.querySelector('input[name="markup"]');
                if (markupField && document.activeElement !== markupField) {
                  let markupCalc = tarifa - tarifa / 1.2;
                  markupCalc = Math.abs(markupCalc);
                  markupField.value = markupCalc.toFixed(2);
                }
              }
            }
          }
        });

        // Listener para permitir colar datas no formato DD/MM/YYYY
        document.addEventListener("paste", function (e) {
          const target = e.target;
          if (target && target.type === "date") {
            const pasteData = e.clipboardData.getData("text");
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = pasteData.match(regex);
            if (match) {
              e.preventDefault();
              const dd = match[1],
                mm = match[2],
                yyyy = match[3];
              target.value = `${yyyy}-${mm}-${dd}`;
            }
          }
        });

        // Listener para apagar a data inteira ao pressionar Backspace em campos do tipo "date"
        document.addEventListener("keydown", function (e) {
          if (
            e.key === "Backspace" &&
            !e.ctrlKey &&
            !e.metaKey &&
            !e.altKey
          ) {
            const target = e.target;
            if (target && target.type === "date") {
              target.value = "";
              e.preventDefault();
            }
          }
        });

        // Atualização dos estilos dos botões de ação
        const style = document.createElement('style');
        style.textContent = `
          .clone-row, .remove-row {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
          }

          .clone-row:hover {
            background-color: #247a3b !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }

          .remove-row:hover {
            background-color: #c82333 !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }

          .clone-row i, .remove-row i {
            font-size: 1.1rem;
          }
        `;
        document.head.appendChild(style);

        initializeResizableColumns();

        // Adicionar listener para remover o estilo de erro quando um TFD for selecionado
        document.getElementById("clienteSelecionado").addEventListener("change", function() {
          this.classList.remove("not-selected");
        });
      });

      function initializeResizableColumns() {
        const table = document.getElementById('vendasTable');
        const headers = table.querySelectorAll('th');
        
        headers.forEach(header => {
          // Criar e adicionar a alça de redimensionamento
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          header.appendChild(resizeHandle);
          
          let isResizing = false;
          let startX, startWidth;
          
          resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startX = e.pageX;
            startWidth = header.offsetWidth;
            
            // Adicionar classe para indicar redimensionamento ativo
            header.classList.add('resizing');
          });
          
          document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const width = startWidth + (e.pageX - startX);
            
            // Limitar largura mínima e máxima
            if (width >= 100 && width <= 400) {
              header.style.width = `${width}px`;
              
              // Ajustar a largura da coluna correspondente
              const columnIndex = Array.from(headers).indexOf(header);
              const cells = table.querySelectorAll(`td:nth-child(${columnIndex + 1})`);
              cells.forEach(cell => {
                cell.style.width = `${width}px`;
              });
            }
          });
          
          document.addEventListener('mouseup', () => {
            if (isResizing) {
              isResizing = false;
              header.classList.remove('resizing');
              
              // Salvar as larguras no localStorage
              const columnWidths = {};
              headers.forEach((h, index) => {
                columnWidths[index] = h.style.width;
              });
              localStorage.setItem('columnWidths', JSON.stringify(columnWidths));
            }
          });
        });
        
        // Restaurar larguras salvas
        const savedWidths = localStorage.getItem('columnWidths');
        if (savedWidths) {
          const widths = JSON.parse(savedWidths);
          headers.forEach((header, index) => {
            if (widths[index]) {
              header.style.width = widths[index];
              const cells = table.querySelectorAll(`td:nth-child(${index + 1})`);
              cells.forEach(cell => {
                cell.style.width = widths[index];
              });
            }
          });
        }
      }
    </script>
  </body>
</html>
